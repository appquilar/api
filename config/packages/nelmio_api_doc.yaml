nelmio_api_doc:
    html_config:
        assets_mode: 'offline'
    documentation:
        info:
            title: "Appquilar API"
            description: "API for Appquilar platform"
            version: "0.1.0"
        areas:
            exclude_path_patterns:
                - ^/_error
        paths:
            # Authentication
            /api/auth/register:
                post:
                    summary: "Register a new user"
                    tags:
                        - Authentication
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    $ref: "#/components/schemas/RegisterUserDTO"
                    responses:
                        "201":
                            description: "User registered successfully"
                        "400":
                            description: "Validation error"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/ValidationError"
            /api/auth/login:
                post:
                    summary: "Login a user"
                    tags: ["Authentication"]
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    $ref: "#/components/schemas/LoginUserDTO"
                    responses:
                        "200":
                            description: "Successful login"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            token:
                                                type: string
                                                example: "eyJhbGciOiJIUzI1NiIsIn..."
                        "400":
                            description: "Invalid credentials"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            error:
                                                type: string
                                                example: "Invalid credentials"
            /api/auth/logout:
                post:
                    summary: "Logout a user"
                    description: "Revokes the user's access token, effectively logging them out."
                    tags:
                        - Authentication
                    security:
                        - BearerAuth: [ ]
                    responses:
                        "200":
                            description: "Logout successful"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            success:
                                                type: boolean
                                                example: "true"
                        "401":
                            description: "Unauthorized - Missing or invalid token"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            error:
                                                type: string
                                                example: "Invalid token"

            /api/auth/forgot-password:
                post:
                    summary: "Request a password reset link"
                    tags: ["Authentication"]
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    type: object
                                    required: ["email"]
                                    properties:
                                        email:
                                            type: string
                                            example: "user@example.com"
                    responses:
                        "200":
                            description: "Forgot password email sent successfully"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            message:
                                                type: string
                                                example: "Forgot password email sent successfully"
                        "400":
                            description: "Validation error"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/ValidationError"
            /api/auth/change-password:
                post:
                    summary: "Change password using the forgot password token"
                    tags: ["Authentication"]
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    type: object
                                    properties:
                                        email:
                                            type: string
                                            example: "user@example.com"
                                        token:
                                            type: string
                                            format: uuid
                                            example: "cdd52b98-9183-41b9-8e27-4d12c5ddcf3c"
                                        password:
                                            type: string
                                            example: "NewSecurePass123"
                    responses:
                        204:
                            description: "Password changed successfully"
                        400:
                            description: "Validation error"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/ValidationError"
                        401:
                            description: "Invalid or expired token"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            success:
                                                type: boolean
                                                example: false
                                            errors:
                                                type: object
                                                example: "Invalid or expired token"
            # User
            /api/me:
                get:
                    summary: "Get the authenticated user's details"
                    description: "Fetch the details of the currently authenticated user"
                    tags:
                        - "User"
                    security:
                        - bearerAuth: [ ]
                    responses:
                        "200":
                            description: "User details retrieved successfully"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/User"
                        "401":
                            description: "Unauthorized - User not authenticated"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            error:
                                                type: string
                                                example: "Unauthorized"
            /api/users/{user_id}:
                get:
                    summary: "Get the specific user's details"
                    description: "Fetch the details of an user by its ID"
                    tags:
                        - "User"
                    parameters:
                        - in: path
                          name: user_id
                          schema:
                              type: uuid
                          required: true
                          description: UUID of the user to get
                    responses:
                        "200":
                            description: "User details retrieved successfully"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/User"
                patch:
                    summary: "Update user details"
                    description: "Allows an admin or the user themselves to update user details (name, roles, etc.)."
                    tags:
                        - "User"
                    parameters:
                        - name: "user_id"
                          in: "path"
                          required: true
                          schema:
                              type: "string"
                          example: "cdd52b98-9183-41b9-8e27-4d12c5ddcf3c"
                    security:
                        - BearerAuth: [ ]
                    requestBody:
                        content:
                            application/json:
                                schema:
                                    $ref: "#/components/schemas/UpdateUserDTO"
                    responses:
                        "204":
                            description: "User updated successfully"
                        "401":
                            description: "Unauthorized"
                        "404":
                            description: "User not found"

            /api/users/{user_id}/change-password:
                patch:
                    summary: "Change the user's password"
                    description: "Allows an authenticated user to update their password."
                    tags:
                        - "User"
                    parameters:
                        - name: "user_id"
                          in: "path"
                          required: true
                          schema:
                              type: "string"
                          example: "cdd52b98-9183-41b9-8e27-4d12c5ddcf3c"
                    security:
                        - bearerAuth: []
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    $ref: "#/components/schemas/UpdateUserPasswordDTO"
                    responses:
                        "204":
                            description: "Password changed successfully"
                        "401":
                            description: "Unauthorized - Invalid credentials or not authenticated"

            /api/companies:
                post:
                    tags:
                        - Company
                    summary: "Create a new company"
                    description: "Creates a new company and assigns an owner."
                    security:
                        - bearerAuth: []
                    operationId: createCompany
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    $ref: "#/components/schemas/CreateCompanyDto"
                    responses:
                        "201":
                            description: "Company successfully created"
                        "400":
                            description: "Validation error"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/ValidationError"
                        "401":
                            description: "Unauthorized - User not authenticated"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            error:
                                                type: string
                                                example: "Unauthorized"

            /api/companies/{company_id}:
                get:
                    summary: "Get details of a company"
                    tags:
                        - Company
                    parameters:
                        - in: path
                          name: companyId
                          required: true
                          schema:
                              type: string
                              format: uuid
                    responses:
                        200:
                            description: "Company details retrieved successfully"
                            content:
                                application/json:
                                    schema:
                                        $ref: "#/components/schemas/Company"
                        404:
                            description: "Company not found"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            error:
                                                type: string
                                                example: "Company with id xxxx-xxx-xxx-xx-xxxx not found"
            /api/companies/{company_id}/users:
                get:
                    summary: "Get paginated list of users for a company"
                    description: "Retrieves a paginated list of users associated with a company. Only accessible by company admins or platform administrators."
                    tags:
                        - Company
                    parameters:
                        - name: company_id
                          in: path
                          required: true
                          description: "The UUID of the company"
                          schema:
                              type: string
                              format: uuid
                        - name: page
                          in: query
                          required: false
                          description: "The page number (default: 1)"
                          schema:
                              type: integer
                              default: 1
                        - name: per_page
                          in: query
                          required: false
                          description: "Number of users per page (default: 10, max: 50)"
                          schema:
                              type: integer
                              default: 10
                              maximum: 50
                    security:
                        - bearerAuth: [ ]
                    responses:
                        "200":
                            description: "Successful response with paginated company users"
                            content:
                                application/json:
                                    schema:
                                        type: object
                                        properties:
                                            data:
                                                type: array
                                                items:
                                                    $ref: "#/components/schemas/CompanyUser"
                                            total:
                                                type: integer
                                                description: "Total number of users"
                                                example: 3
                                            page:
                                                type: integer
                                                description: "Current page number"
                                                example: 1
                        "401":
                            description: "Unauthorized - User is not logged in"
                        "404":
                            description: "Company not found"
                post:
                    summary: "Invite a User to a Company"
                    description: >
                        Assign an existing user to a company or send an invitation to a new user.
                        Only a company admin or platform admin can perform this action.
                    operationId: addUserToCompany
                    tags:
                        - Company
                    security:
                        - BearerAuth: [ ]
                    parameters:
                        - name: company_id
                          in: path
                          required: true
                          schema:
                              type: string
                              format: uuid
                          description: "The ID of the company where the user will be added."
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    type: object
                                    properties:
                                        userId:
                                            type: string
                                            format: uuid
                                            nullable: true
                                            description: "The existing user's ID (if assigning an existing user). If null, an invitation will be sent."
                                        email:
                                            type: string
                                            format: email
                                            example: "user@example.com"
                                            description: "The email of the user (required for both existing and new users)."
                                        role:
                                            type: string
                                            enum: [ ADMIN, CONTRIBUTOR ]
                                            example: "CONTRIBUTOR"
                                            description: "The role assigned to the user within the company."
                                    required:
                                        - email
                                        - role
                    responses:
                        "201":
                            description: "User successfully added to the company (or invited)."
                        "400":
                            description: "Invalid request. Possible reasons: malformed UUID, missing required fields, or the user already belongs to another company."
                        "401":
                            description: "Unauthorized - Only a company admin or platform admin can perform this action."

                        "404":
                            description: "Company not found."
            /api/companies/{company_id}/users/{user_id}:
                patch:
                    tags:
                        - Company
                    summary: "Update a user's role in a company"
                    description: "Allows admins to change the role of a user in a company."
                    parameters:
                        - in: path
                          name: company_id
                          required: true
                          schema:
                              type: string
                              format: uuid
                          description: "UUID of the company."
                        - in: path
                          name: user_id
                          required: true
                          schema:
                              type: string
                              format: uuid
                          description: "UUID of the user."
                    requestBody:
                        required: true
                        content:
                            application/json:
                                schema:
                                    type: object
                                    properties:
                                        role:
                                            type: string
                                            enum: [ ADMIN, CONTRIBUTOR ]
                                            example: "ADMIN"
                    responses:
                        "204":
                            description: "User role updated successfully."
                        "401":
                            description: "Unauthorized - User lacks necessary permissions."
                        "404":
                            description: "User not found in the company."
                delete:
                    summary: Remove a user from a company
                    tags:
                        - Company
                    parameters:
                        - name: company_id
                          in: path
                          required: true
                          schema:
                              type: string
                              format: uuid
                        - name: user_id
                          in: path
                          required: true
                          schema:
                              type: string
                              format: uuid
                    responses:
                        "204":
                            description: User removed from company successfully.
                        "400":
                            description: You can't remove yourself.
                        "401":
                            description: Unauthorized to perform this action.
                        "404":
                            description: User is not part of this company
        components:
            schemas:
                RegisterUserDTO:
                    type: object
                    required:
                        - user_id
                        - email
                        - password
                    properties:
                        user_id:
                            type: string
                            format: uuid
                            example: "cdd52b98-9183-41b9-8e27-4d12c5ddcf3c"
                        email:
                            type: string
                            example: "testuser@example.com"
                        password:
                            type: string
                            example: "SecurePass123"
                LoginUserDTO:
                    type: object
                    required: ["email", "password"]
                    properties:
                        email:
                            type: string
                            example: "user@example.com"
                        password:
                            type: string
                            example: "SecurePass123"
                UpdateUserDTO:
                    type: "object"
                    properties:
                        first_name:
                            type: "string"
                            example: "John"
                        last_name:
                            type: "string"
                            example: "Doe"
                        roles:
                            type: array
                            items:
                                $ref: "#/components/schemas/UserRoles"
                UpdateUserPasswordDTO:
                    type: object
                    required: ["old_password", "new_password"]
                    properties:
                        old_password:
                            type: string
                            example: "OldPassword123"
                        new_password:
                            type: string
                            example: "NewSecurePassword456"
                UserRoles:
                    type: string
                    enum:
                        - ROLE_USER
                        - ROLE_ADMIN
                User:
                    type: object
                    properties:
                        id:
                            type: string
                            format: uuid
                            example: "cdd52b98-9183-41b9-8e27-4d12c5ddcf3c"
                        first_name:
                            type: string
                            example: "John"
                        last_name:
                            type: string
                            example: "Doe"
                        email:
                            type: string
                            format: email
                            example: "testuser@example.com"
                        roles:
                            type: array
                            items:
                                $ref: "#/components/schemas/UserRoles"
                Company:
                    type: object
                    properties:
                        company_id:
                            type: string
                            format: uuid
                            example: "550e8400-e29b-41d4-a716-446655440000"
                        name:
                            type: string
                            example: "Acme Inc."
                        owner_id:
                            type: string
                            format: uuid
                            example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
                        description:
                            type: string
                            example: "Leading provider of innovative solutions"
                        fiscal_identifier:
                            type: string
                            description: "In Spain, the CIF"
                            example: "123456789"
                        address:
                            type: string
                            example: "1234 Elm Street, Springfield"
                        postal_code:
                            type: string
                            example: "12345"
                        city:
                            type: string
                            example: "Springfield"
                        contact_email:
                            type: string
                            format: email
                            example: "contact@acme.com"
                        phone_number:
                            $ref: "#/components/schemas/PhoneNumber"
                CompanyUser:
                    type: object
                    properties:
                        user_id:
                            type: string
                            format: uuid
                            nullable: true
                            description: "UUID of the user"
                        email:
                            type: string
                            format: email
                            description: "User's email address"
                        role:
                            type: string
                            enum: [ ADMIN, CONTRIBUTOR ]
                            description: "Role of the user in the company"
                        status:
                            type: string
                            enum: [ ACCEPTED, PENDING, EXPIRED ]
                            description: "Status of the user's invitation"
                PhoneNumber:
                    type: object
                    properties:
                        prefix:
                            type: string
                            example: "+34"
                        country_code:
                            type: string
                            example: "ES"
                        number:
                            type: string
                            example: "666000000"
                ValidationError:
                    type: object
                    properties:
                        success:
                            type: boolean
                            example: false
                        error:
                            type: object
                            properties:
                                errors:
                                    type: array
                                    items:
                                        type: array
                                        items:
                                            field:
                                                type: string
                                                example: "auth.register.user_id.not_blank"
                CreateCompanyDto:
                    type: object
                    properties:
                        company_id:
                            type: string
                            format: uuid
                            example: "550e8400-e29b-41d4-a716-446655440000"
                        name:
                            type: string
                            example: "Acme Inc."
                        owner_id:
                            type: string
                            format: uuid
                            example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
                        description:
                            type: string
                            example: "Leading provider of innovative solutions"
                        fiscal_identifier:
                            type: string
                            description: "In Spain, the CIF"
                            example: "123456789"
                        address:
                            type: string
                            example: "1234 Elm Street, Springfield"
                        postal_code:
                            type: string
                            example: "12345"
                        city:
                            type: string
                            example: "Springfield"
                        contact_email:
                            type: string
                            format: email
                            example: "contact@acme.com"
                        phone_number_country_code:
                            type: string
                            example: "ES"
                        phone_number_prefix:
                            type: string
                            example: "+34"
                        phone_number_number:
                            type: string
                            example: "666000000"
